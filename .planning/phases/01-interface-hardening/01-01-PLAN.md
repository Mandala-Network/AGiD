---
phase: 01-interface-hardening
plan: 01
type: execute
---

<objective>
Fix cryptographic integrity issues: hash truncation vulnerability and unsigned audit entries.

Purpose: Ensure cryptographic operations provide full security guarantees (256-bit hashes, signed audit trails).
Output: Fixed hash function using full SHA-256, signed audit entries in team vaults.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md

**Key files:**
@src/vault/local-encrypted-vault.ts
@src/team/team-vault.ts
@src/team/secure-team-vault.ts
@src/audit/signed-audit.ts

**Issues being addressed:**
- Hash Truncation Vulnerability (CONCERNS.md): Content hash truncated to 64 bits instead of 256 bits
- Unsigned Audit Trail Entries (CONCERNS.md): Audit logs cannot prove who made changes (HIPAA/SOC2 blocker)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hash truncation vulnerability</name>
  <files>src/vault/local-encrypted-vault.ts</files>
  <action>
In `hashContent()` method (line 476-478), remove `.slice(0, 16)` to use full 64-character hex string (256 bits).

Current (vulnerable):
```typescript
private hashContent(content: string): string {
  return createHash('sha256').update(content).digest('hex').slice(0, 16);
}
```

Fixed:
```typescript
private hashContent(content: string): string {
  return createHash('sha256').update(content).digest('hex');
}
```

WHY: 64-bit truncation has only 2^32 collision resistance (birthday attack). Full SHA-256 provides 2^128 collision resistance.
  </action>
  <verify>Run `npm run build` - no type errors. Grep for `.slice(0, 16)` in vault files - should not exist.</verify>
  <done>hashContent returns full 64-character hex string (256 bits)</done>
</task>

<task type="auto">
  <name>Task 2: Sign audit trail entries in TeamVault</name>
  <files>src/team/team-vault.ts</files>
  <action>
In `createAuditEntry()` method (around line 700-718), sign the entry using the wallet before pushing to audit log.

Current (insecure):
```typescript
const entry: TeamAuditEntry = {
  ...fields,
  signature: '', // Would be signed in production
};
this.auditLog.push(entry);
```

Fixed approach:
1. Create entry data object without signature
2. Sign entry data using `this.wallet.createSignature()`
3. Add signature to entry
4. Push to audit log

Use same signing pattern as `SignedAuditTrail.createEntry()` in `src/audit/signed-audit.ts`:
- protocolID: `[0, 'agidentity-team-audit']` (level 0 = publicly verifiable)
- keyID: `audit-${entry.entryId}`
- data: JSON.stringify of entry fields (without signature)

Make the method async (it already returns Promise<void>).
  </action>
  <verify>Run `npm run build` - no errors. Read the method to confirm signature is populated.</verify>
  <done>TeamVault.createAuditEntry signs entries with wallet before storing</done>
</task>

<task type="auto">
  <name>Task 3: Sign audit trail entries in SecureTeamVault</name>
  <files>src/team/secure-team-vault.ts</files>
  <action>
Apply same fix to SecureTeamVault's `createAuditEntry()` method (around line 800-820).

The implementation should mirror TeamVault's fix:
1. Create entry data object without signature
2. Sign using `this.wallet.createSignature()`
3. Add signature to entry
4. Push to audit log

Use same protocolID and keyID pattern for consistency.
  </action>
  <verify>Run `npm run build` - no errors. Grep for `signature: ''` in team/*.ts - should return no matches.</verify>
  <done>SecureTeamVault.createAuditEntry signs entries with wallet before storing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (or only pre-existing warnings)
- [ ] `grep -r "slice(0, 16)" src/vault/` returns no matches
- [ ] `grep -r "signature: ''" src/team/` returns no matches
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Hash function uses full 256-bit output
- Audit entries are cryptographically signed
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/01-interface-hardening/01-01-SUMMARY.md`
</output>
