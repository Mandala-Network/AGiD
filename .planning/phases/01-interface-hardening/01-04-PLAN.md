---
phase: 01-interface-hardening
plan: 04
type: execute
---

<objective>
Add session cleanup to prevent memory leaks from unbounded session/context maps.

Purpose: Prevent memory exhaustion in long-running processes by cleaning up stale sessions.
Output: Session timeout and cleanup routines in both plugin files.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md

**Key files:**
@src/plugin/agidentity-plugin.ts
@src/plugin/secure-plugin.ts

**Issues being addressed:**
- Session Map Memory Leak (CONCERNS.md): userContexts and sessionEncryptions maps never cleared
- Files: agidentity-plugin.ts (lines 77-78), secure-plugin.ts (lines 110-111)
- Measurement: Grows indefinitely with user count
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session cleanup to agidentity-plugin</name>
  <files>src/plugin/agidentity-plugin.ts</files>
  <action>
Add session timeout and cleanup to the plugin's session maps (userContexts, sessionEncryptions at lines 77-78).

1. Add configuration constants near the top of register():
```typescript
const SESSION_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes
const CLEANUP_INTERVAL_MS = 5 * 60 * 1000; // Run cleanup every 5 minutes
```

2. Create cleanup function after the maps are declared:
```typescript
function cleanupStaleSessions(): void {
  const now = Date.now();

  // Clean userContexts based on lastActivityAt
  for (const [key, context] of userContexts) {
    if (now - context.lastActivityAt > SESSION_TIMEOUT_MS) {
      userContexts.delete(key);
    }
  }

  // Clean sessionEncryptions - remove if corresponding context is gone
  for (const key of sessionEncryptions.keys()) {
    if (!userContexts.has(key)) {
      sessionEncryptions.delete(key);
    }
  }
}
```

3. Start cleanup interval:
```typescript
const cleanupInterval = setInterval(cleanupStaleSessions, CLEANUP_INTERVAL_MS);

// Ensure cleanup stops if plugin is unregistered
// Store reference for potential future cleanup
void cleanupInterval; // Prevent unused variable warning if no unregister hook
```

4. If the plugin API has an unregister or destroy hook, clear the interval there. If not, add a comment noting this.

WHY: Without cleanup, a server handling many users accumulates contexts forever, eventually exhausting memory.
  </action>
  <verify>Run `npm run build` - no type errors. Run `npm run lint` - no new lint errors.</verify>
  <done>agidentity-plugin has session timeout (30min) and cleanup routine (every 5min)</done>
</task>

<task type="auto">
  <name>Task 2: Add session cleanup to secure-plugin</name>
  <files>src/plugin/secure-plugin.ts</files>
  <action>
Apply same session cleanup pattern to secure-plugin's maps (verifiedSessions, sessionEncryptions at lines 110-111).

1. Add same configuration constants:
```typescript
const SESSION_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes
const CLEANUP_INTERVAL_MS = 5 * 60 * 1000; // Run cleanup every 5 minutes
```

2. Create cleanup function. For secure-plugin, check the VerifiedSession structure for timestamp field (likely `verifiedAt` or similar):
```typescript
function cleanupStaleSessions(): void {
  const now = Date.now();

  // Clean verifiedSessions based on verification time
  for (const [key, session] of verifiedSessions) {
    // Use appropriate timestamp field from VerifiedSession
    const sessionAge = now - (session.verifiedAt ?? session.timestamp ?? 0);
    if (sessionAge > SESSION_TIMEOUT_MS) {
      verifiedSessions.delete(key);
    }
  }

  // Clean sessionEncryptions - remove if corresponding session is gone
  for (const key of sessionEncryptions.keys()) {
    if (!verifiedSessions.has(key)) {
      sessionEncryptions.delete(key);
    }
  }
}
```

3. Start cleanup interval (same pattern as agidentity-plugin).

4. Adapt to actual VerifiedSession fields - read the interface to find correct timestamp field.

WHY: secure-plugin has same memory leak issue - verified sessions accumulate forever.
  </action>
  <verify>Run `npm run build` - no type errors. Run `npm run lint` - no new lint errors.</verify>
  <done>secure-plugin has session timeout (30min) and cleanup routine (every 5min)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (or only pre-existing warnings)
- [ ] Both plugin files have cleanupStaleSessions function
- [ ] Both plugin files have setInterval for periodic cleanup
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Session maps have 30-minute timeout
- Cleanup runs every 5 minutes
- No TypeScript errors introduced
- Phase 1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-interface-hardening/01-04-SUMMARY.md`

This is the final plan for Phase 1. After completion:
- Update STATE.md to mark Phase 1 complete
- Ready for Phase 2: MessageBox Channel
</output>
