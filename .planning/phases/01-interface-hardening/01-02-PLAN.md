---
phase: 01-interface-hardening
plan: 02
type: execute
---

<objective>
Add Zod validation to JSON parsing points to prevent corrupted/malicious input from causing runtime errors.

Purpose: Fail fast with clear error messages when JSON structure doesn't match expected schema.
Output: Zod schemas for encryption metadata and per-interaction envelopes, validation at parse points.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md

**Key files:**
@src/vault/local-encrypted-vault.ts
@src/encryption/per-interaction.ts
@src/types/index.ts

**Tech stack available:**
- Zod is already a dependency (mentioned in CONCERNS.md: "Add Zod validation (already a dependency)")

**Issues being addressed:**
- JSON Parsing Without Validation (CONCERNS.md): Parses JSON but doesn't validate structure with schemas
- Files: local-encrypted-vault.ts (lines 454, 470), per-interaction.ts (line 213)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Zod schemas and validate in local-encrypted-vault</name>
  <files>src/vault/local-encrypted-vault.ts</files>
  <action>
1. Import zod at top of file:
```typescript
import { z } from 'zod';
```

2. Define schema for EncryptionMeta (near the interface definition around line 48-55):
```typescript
const EncryptionMetaSchema = z.object({
  version: z.literal(1),
  keyId: z.string(),
  iv: z.string(),
  originalPath: z.string(),
  originalHash: z.string(),
  encryptedAt: z.number(),
});
```

3. In `decryptContent()` method (line 454), replace raw JSON.parse:
```typescript
// Before:
const meta: EncryptionMeta = JSON.parse(metaBuffer.toString('utf-8'));

// After:
const metaRaw = JSON.parse(metaBuffer.toString('utf-8'));
const meta = EncryptionMetaSchema.parse(metaRaw);
```

4. In `extractMeta()` method (line 470), add validation:
```typescript
// Before:
return JSON.parse(metaBuffer.toString('utf-8'));

// After:
const parsed = JSON.parse(metaBuffer.toString('utf-8'));
return EncryptionMetaSchema.parse(parsed);
```

WHY: Without validation, corrupted files cause confusing property access errors deep in the code. With Zod, you get "Expected string, received undefined" at the parse point.
  </action>
  <verify>Run `npm run build` - no type errors. Run `npm test` - existing tests pass.</verify>
  <done>EncryptionMeta parsing validates structure with Zod schema</done>
</task>

<task type="auto">
  <name>Task 2: Add Zod schemas and validate in per-interaction encryption</name>
  <files>src/encryption/per-interaction.ts</files>
  <action>
1. Import zod at top of file:
```typescript
import { z } from 'zod';
```

2. Find the envelope/message structure being parsed (around line 213) and define appropriate schema. Look at what fields are expected after JSON.parse.

Likely schema (adjust based on actual structure):
```typescript
const EncryptedEnvelopeSchema = z.object({
  keyId: z.string(),
  ciphertext: z.string(),
  timestamp: z.number().optional(),
  // Add other fields as found in the code
});
```

3. Replace raw JSON.parse with validated parse:
```typescript
// Before:
const envelope = JSON.parse(data);

// After:
const envelopeRaw = JSON.parse(data);
const envelope = EncryptedEnvelopeSchema.parse(envelopeRaw);
```

4. If there are multiple JSON.parse calls in this file, validate each one with appropriate schemas.

WHY: Per-interaction encryption handles untrusted input from network. Schema validation prevents injection of unexpected fields.
  </action>
  <verify>Run `npm run build` - no type errors. Run `npm test` - existing tests pass.</verify>
  <done>Per-interaction envelope parsing validates structure with Zod schema</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all existing tests
- [ ] `grep -r "JSON.parse" src/vault/local-encrypted-vault.ts` shows Zod validation follows each parse
- [ ] `grep -r "JSON.parse" src/encryption/per-interaction.ts` shows Zod validation follows each parse
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Zod schemas defined for parsed JSON structures
- JSON.parse calls followed by schema validation
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/01-interface-hardening/01-02-SUMMARY.md`
</output>
