---
phase: 04-openclaw-gateway
plan: 03
type: execute
---

<objective>
Create AGIdentityOpenClawGateway that bridges MessageBox → IdentityGate → OpenClaw → MPC Sign.

Purpose: Wrap OpenClaw with AGIdentity's cryptographic identity layer so every interaction is authenticated, encrypted, and signed.
Output: AGIdentityOpenClawGateway class that integrates all components into production-ready gateway.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-openclaw-gateway/DISCOVERY.md
@.planning/phases/04-openclaw-gateway/04-01-SUMMARY.md
@.planning/phases/04-openclaw-gateway/04-02-SUMMARY.md

# Components to integrate
@src/messaging/messagebox-gateway.ts
@src/identity/identity-gate.ts
@src/openclaw/openclaw-client.ts
@src/wallet/mpc-agent-wallet.ts
@src/audit/signed-audit.ts

**Architecture from PROJECT.md:**
```
MessageBox (P2P) → AGIdentity Gateway → Identity Gate → OpenClaw → MPC Wallet
```

**Key properties:**
- Every message authenticated via IdentityGate
- Every response signed by MPC wallet
- Audit trail for all interactions
- E2E encryption via MessageBox

**From DISCOVERY.md:**
- Inject identity context into OpenClaw sessions
- Sign responses before delivery
- Session isolation per sender
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AGIdentityOpenClawGateway class</name>
  <files>src/gateway/agidentity-openclaw-gateway.ts</files>
  <action>
    Create src/gateway/agidentity-openclaw-gateway.ts implementing the full integration:

    ```typescript
    import type { AgentWallet } from '../wallet/agent-wallet.js';
    import type { BRC100Wallet } from '../types/index.js';
    import type { ProcessedMessage, MessageResponse } from '../messaging/messagebox-gateway.js';
    import type { ChatMessageEvent } from '../types/openclaw-gateway.js';
    import { MessageBoxGateway, createMessageBoxGateway } from '../messaging/messagebox-gateway.js';
    import { IdentityGate } from '../identity/identity-gate.js';
    import { OpenClawClient, createOpenClawClient } from '../openclaw/index.js';
    import { SignedAuditTrail } from '../audit/signed-audit.js';

    export interface AGIdentityOpenClawGatewayConfig {
      /** Agent wallet for identity and signing (can be MPC) */
      wallet: AgentWallet;
      /** Trusted certificate authorities */
      trustedCertifiers: string[];
      /** OpenClaw Gateway URL (default: ws://127.0.0.1:18789) */
      openclawUrl?: string;
      /** OpenClaw auth token */
      openclawToken?: string;
      /** MessageBox configuration */
      messageBoxes?: string[];
      /** Whether to sign all AI responses (default: true) */
      signResponses?: boolean;
      /** Audit trail configuration */
      audit?: {
        /** Whether to enable audit trail (default: true) */
        enabled?: boolean;
      };
    }

    export class AGIdentityOpenClawGateway {
      private config: AGIdentityOpenClawGatewayConfig;
      private wallet: AgentWallet;
      private messageBoxGateway: MessageBoxGateway | null = null;
      private openclawClient: OpenClawClient | null = null;
      private identityGate: IdentityGate | null = null;
      private auditTrail: SignedAuditTrail | null = null;
      private running = false;

      constructor(config: AGIdentityOpenClawGatewayConfig) { ... }

      async initialize(): Promise<void> {
        // 1. Create IdentityGate with wallet
        // 2. Create MessageBoxGateway with onMessage handler
        // 3. Create OpenClawClient and connect
        // 4. Create SignedAuditTrail if enabled
        // 5. Wire up the message flow
      }

      private async handleMessage(message: ProcessedMessage): Promise<MessageResponse | null> {
        // 1. Extract sender identity from verified message
        // 2. Create audit entry for incoming message
        // 3. Build context with sender identity
        // 4. Send to OpenClaw with identity context
        // 5. Wait for AI response (streaming)
        // 6. Sign response with wallet
        // 7. Create audit entry for response
        // 8. Return MessageResponse
      }

      private buildIdentityContext(message: ProcessedMessage): Record<string, unknown> {
        // Include in OpenClaw session context:
        // - senderPublicKey
        // - verified (boolean)
        // - certificateSubject (if available)
        // - conversationId
      }

      private async signResponse(response: string): Promise<{ signature: string; signerPublicKey: string }> {
        // Sign response content with MPC wallet
        // Return signature and signer's public key
      }

      async shutdown(): Promise<void> {
        // 1. Stop MessageBoxGateway
        // 2. Disconnect OpenClawClient
        // 3. Clean up resources
      }

      // Accessors
      isRunning(): boolean { ... }
      getIdentityGate(): IdentityGate | null { ... }
      getOpenClawClient(): OpenClawClient | null { ... }
      getMessageBoxGateway(): MessageBoxGateway | null { ... }
    }
    ```

    Key behaviors:
    1. **Identity verification** - Every incoming message passes through IdentityGate
    2. **Context injection** - Sender identity injected into OpenClaw session
    3. **Response signing** - Every AI response signed with wallet (MPC when available)
    4. **Audit trail** - All interactions logged and signed
    5. **Graceful shutdown** - Clean disconnect from all services

    Error handling:
    - OpenClaw connection failure → retry with backoff, don't crash gateway
    - Identity verification failure → reject message, notify sender
    - Signing failure → log error, send response unsigned (with warning flag)
  </action>
  <verify>
    - `ls src/gateway/agidentity-openclaw-gateway.ts` exists
    - `npm run build` succeeds
    - Types are correct
  </verify>
  <done>AGIdentityOpenClawGateway class created with full integration</done>
</task>

<task type="auto">
  <name>Task 2: Add factory function and exports</name>
  <files>src/gateway/index.ts, src/index.ts</files>
  <action>
    1. Create src/gateway/index.ts:
    ```typescript
    export {
      AGIdentityOpenClawGateway,
      type AGIdentityOpenClawGatewayConfig
    } from './agidentity-openclaw-gateway.js';

    // Factory function
    export async function createAGIdentityGateway(
      config: AGIdentityOpenClawGatewayConfig
    ): Promise<AGIdentityOpenClawGateway> {
      const gateway = new AGIdentityOpenClawGateway(config);
      await gateway.initialize();
      return gateway;
    }
    ```

    2. Update src/index.ts to export from './gateway':
    ```typescript
    export * from './gateway/index.js';
    ```

    3. Environment variable support:
       - OPENCLAW_GATEWAY_URL
       - OPENCLAW_GATEWAY_TOKEN
       - AGID_SIGN_RESPONSES (default: true)
       - AGID_AUDIT_ENABLED (default: true)
  </action>
  <verify>
    - `npm run build` succeeds
    - Factory function exported from package
  </verify>
  <done>Factory function and exports added</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests</name>
  <files>src/gateway/agidentity-openclaw-gateway.test.ts</files>
  <action>
    Create integration tests:

    1. **Initialization tests:**
       - Should initialize all components
       - Should fail gracefully if OpenClaw unavailable
       - Should handle identity gate errors

    2. **Message flow tests (mocked):**
       - Should verify sender identity before forwarding
       - Should inject identity context into OpenClaw
       - Should sign AI responses
       - Should create audit entries

    3. **Error handling tests:**
       - Should reject unverified messages when required
       - Should handle OpenClaw disconnection
       - Should continue after signing failure (with warning)

    4. **Lifecycle tests:**
       - Should shut down gracefully
       - Should clean up all resources

    Use mocks for MessageBox, OpenClaw, and wallet - these are integration tests for the gateway logic, not live tests.
  </action>
  <verify>
    - `npm test src/gateway/` passes
    - Coverage includes message flow and error handling
  </verify>
  <done>Integration tests passing for AGIdentityOpenClawGateway</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `src/gateway/agidentity-openclaw-gateway.ts` created
- [ ] `src/gateway/index.ts` exports gateway and factory
- [ ] `src/index.ts` re-exports gateway module
- [ ] `npm run build` succeeds
- [ ] `npm test src/gateway/` passes
- [ ] Full message flow: MessageBox → Identity → OpenClaw → Sign → Return
</verification>

<success_criteria>

- AGIdentityOpenClawGateway integrates MessageBox, IdentityGate, OpenClaw, MPC signing
- Every message authenticated before reaching OpenClaw
- Every response signed before delivery
- Audit trail for all interactions
- Integration tests passing
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-openclaw-gateway/04-03-SUMMARY.md`:

# Phase 4 Plan 03: AGIdentity OpenClaw Gateway Summary

**[One-liner summary]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- [File list with descriptions]

## Decisions Made

[Decisions, or "None"]

## Issues Encountered

[Issues, or "None"]

## Next Step

Phase 4 complete, ready for Phase 5: Shad Semantic Memory
</output>
