---
phase: 04-openclaw-gateway
plan: 01
type: execute
---

<objective>
Remove speculative OpenClaw plugin code and replace with accurate OpenClaw types based on actual Gateway protocol.

Purpose: Clean foundation for real OpenClaw integration - remove incorrect assumptions, add correct types.
Output: Removed src/plugin/, updated src/types/ with accurate OpenClaw Gateway types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-openclaw-gateway/DISCOVERY.md

# Prior phase context
@.planning/phases/3.1-mpc-production-integration/3.1-01-SUMMARY.md
@.planning/phases/02-messagebox-channel/02-03-SUMMARY.md

# Existing code to remove
@src/plugin/agidentity-plugin.ts
@src/plugin/secure-plugin.ts
@src/types/openclaw-plugin.ts

**Tech stack available:**
- @bsv/wallet-toolbox-mpc (file dependency)
- MessageBoxGateway for MessageBox communication
- MPCAgentWallet for signing

**Established patterns:**
- Gateway pattern for unified communication entry point
- Dependency injection for external dependencies
- Environment-based configuration

**Constraining decisions:**
- Phase 3: MPC wallet uses dependency injection
- Phase 2: MessageBoxGateway as unified entry point
- DISCOVERY.md: OpenClaw uses WebSocket protocol, not plugin SDK
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove speculative plugin directory</name>
  <files>src/plugin/agidentity-plugin.ts, src/plugin/secure-plugin.ts, src/plugin/index.ts, src/index.ts</files>
  <action>
    1. Delete the entire src/plugin/ directory - it contains speculative code based on incorrect OpenClaw assumptions
    2. Update src/index.ts to remove any exports from './plugin'
    3. Update src/types/index.ts to remove exports from './openclaw-plugin' if present

    Rationale: DISCOVERY.md confirms OpenClaw has no plugin SDK. The existing plugin code (createAGIdentityPlugin, etc.) implements an API that doesn't exist. We need to start fresh with the actual WebSocket protocol.
  </action>
  <verify>
    - `ls src/plugin/` returns "No such file or directory"
    - `npm run build` still succeeds
    - `grep -r "from.*plugin" src/` shows no broken imports
  </verify>
  <done>src/plugin/ directory removed, build passes, no broken imports</done>
</task>

<task type="auto">
  <name>Task 2: Create accurate OpenClaw Gateway types</name>
  <files>src/types/openclaw-gateway.ts, src/types/index.ts</files>
  <action>
    Replace src/types/openclaw-plugin.ts with src/types/openclaw-gateway.ts containing types based on actual OpenClaw Gateway WebSocket protocol from DISCOVERY.md:

    1. Delete src/types/openclaw-plugin.ts

    2. Create src/types/openclaw-gateway.ts with:
    ```typescript
    /**
     * OpenClaw Gateway WebSocket Protocol Types
     * Based on actual OpenClaw Gateway protocol at ws://127.0.0.1:18789
     */

    // Message types following OpenClaw protocol
    export interface OpenClawRequest {
      type: 'req';
      id: string;
      method: string;
      params?: Record<string, unknown>;
    }

    export interface OpenClawResponse {
      type: 'res';
      id: string;
      ok: boolean;
      payload?: Record<string, unknown>;
      error?: {
        code: string;
        message: string;
      };
    }

    export interface OpenClawEvent {
      type: 'event';
      event: string;
      payload: Record<string, unknown>;
      seq?: number;
      stateVersion?: number;
    }

    export type OpenClawMessage = OpenClawRequest | OpenClawResponse | OpenClawEvent;

    // Connection handshake types
    export interface ConnectParams {
      auth?: {
        token?: string;
        password?: string;
      };
      deviceId?: string;
      role?: 'operator' | 'node';
      caps?: string[];
    }

    export interface ConnectChallengeEvent {
      type: 'event';
      event: 'connect.challenge';
      payload: {
        nonce: string;
      };
    }

    export interface HelloOkEvent {
      type: 'event';
      event: 'hello-ok';
      payload: {
        auth?: {
          deviceToken?: string;
        };
        session?: {
          id: string;
        };
      };
    }

    // Chat/messaging types
    export interface ChatSendParams {
      sessionId?: string;
      content: string;
      role?: 'user' | 'assistant';
      context?: {
        senderIdentity?: string;
        senderPublicKey?: string;
        verified?: boolean;
        certificateSubject?: string;
      };
    }

    export interface ChatMessageEvent {
      type: 'event';
      event: 'chat.message';
      payload: {
        sessionId: string;
        messageId: string;
        role: 'user' | 'assistant';
        content: string;
        toolCalls?: ToolCall[];
        done?: boolean;
      };
    }

    export interface ToolCall {
      id: string;
      name: string;
      params: Record<string, unknown>;
      result?: {
        success: boolean;
        output?: unknown;
        error?: string;
      };
    }

    // Session types
    export interface SessionInfo {
      id: string;
      agentId?: string;
      channel?: string;
      peerId?: string;
      createdAt: number;
      lastActivity: number;
    }

    // Gateway configuration for AGIdentity
    export interface OpenClawGatewayConfig {
      /** WebSocket URL (default: ws://127.0.0.1:18789) */
      gatewayUrl?: string;
      /** Authentication token */
      authToken?: string;
      /** Session scope strategy */
      sessionScope?: 'shared' | 'per-sender' | 'per-conversation';
      /** Reconnection settings */
      reconnect?: {
        maxAttempts?: number;
        delayMs?: number;
        backoffMultiplier?: number;
      };
    }
    ```

    3. Update src/types/index.ts to export from './openclaw-gateway' instead of './openclaw-plugin'
  </action>
  <verify>
    - `ls src/types/openclaw-gateway.ts` exists
    - `ls src/types/openclaw-plugin.ts` returns "No such file"
    - `npm run build` succeeds
    - Types are exported from package
  </verify>
  <done>Accurate OpenClaw Gateway types created, old plugin types removed, build passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `rm -rf src/plugin/` executed, directory gone
- [ ] `src/types/openclaw-plugin.ts` deleted
- [ ] `src/types/openclaw-gateway.ts` created with protocol types
- [ ] `npm run build` succeeds without errors
- [ ] No imports reference removed files
</verification>

<success_criteria>

- All speculative plugin code removed
- Accurate OpenClaw Gateway types created based on actual protocol
- Build passes
- No broken imports
</success_criteria>

<output>
After completion, create `.planning/phases/04-openclaw-gateway/04-01-SUMMARY.md`:

# Phase 4 Plan 01: Remove Plugin Code, Add Gateway Types Summary

**[One-liner summary]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- [File list with descriptions]

## Decisions Made

[Decisions, or "None"]

## Issues Encountered

[Issues, or "None"]

## Next Step

Ready for 04-02-PLAN.md (OpenClaw WebSocket Client)
</output>
