---
phase: 04-openclaw-gateway
plan: 02
type: execute
---

<objective>
Create OpenClaw WebSocket client for communicating with OpenClaw Gateway.

Purpose: Enable programmatic communication with OpenClaw's AI agent via its WebSocket control plane.
Output: OpenClawClient class with connection management, message sending, and event handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-openclaw-gateway/DISCOVERY.md
@.planning/phases/04-openclaw-gateway/04-01-SUMMARY.md

# Types created in Plan 01
@src/types/openclaw-gateway.ts

# Existing patterns to follow
@src/messaging/message-client.ts

**Tech stack available:**
- Node.js WebSocket (ws package already in dependencies)
- OpenClaw Gateway types from 04-01

**Established patterns:**
- AGIDMessageClient pattern for WebSocket communication
- Factory functions for initialization (createMessageClient)
- Event-based message handling
- Reconnection with backoff

**From DISCOVERY.md:**
- Protocol: text-frame JSON payloads
- Initial frame must be `connect` request
- Challenge-response handshake with nonce
- Messages: req/res/event pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenClawClient class</name>
  <files>src/openclaw/openclaw-client.ts</files>
  <action>
    Create src/openclaw/openclaw-client.ts implementing WebSocket client for OpenClaw Gateway.

    Structure:
    ```typescript
    import WebSocket from 'ws';
    import { EventEmitter } from 'events';
    import type {
      OpenClawRequest,
      OpenClawResponse,
      OpenClawEvent,
      OpenClawMessage,
      OpenClawGatewayConfig,
      ChatSendParams,
      ChatMessageEvent,
      ConnectParams,
    } from '../types/index.js';

    export interface OpenClawClientConfig extends OpenClawGatewayConfig {
      /** Timeout for requests in ms (default: 30000) */
      requestTimeout?: number;
    }

    export class OpenClawClient extends EventEmitter {
      private config: Required<OpenClawClientConfig>;
      private ws: WebSocket | null = null;
      private connected = false;
      private connecting = false;
      private pendingRequests = new Map<string, { resolve: (r: OpenClawResponse) => void; reject: (e: Error) => void; timeout: ReturnType<typeof setTimeout> }>();
      private requestId = 0;
      private sessionId: string | null = null;
      private deviceToken: string | null = null;
      private reconnectAttempt = 0;

      constructor(config: OpenClawClientConfig = {}) { ... }

      async connect(): Promise<void> { ... }
      async disconnect(): Promise<void> { ... }
      async sendRequest(method: string, params?: Record<string, unknown>): Promise<OpenClawResponse> { ... }
      async sendChat(content: string, options?: Partial<ChatSendParams>): Promise<string> { ... }
      onChatMessage(handler: (event: ChatMessageEvent) => void): void { ... }
      offChatMessage(handler: (event: ChatMessageEvent) => void): void { ... }
      isConnected(): boolean { ... }
      getSessionId(): string | null { ... }
    }
    ```

    Key implementation details:
    1. **Connection:**
       - Connect to gatewayUrl (default: ws://127.0.0.1:18789)
       - Handle `connect.challenge` event with nonce
       - Send `connect` request with auth token
       - Wait for `hello-ok` event
       - Store deviceToken and sessionId

    2. **Request/Response:**
       - Generate unique request IDs
       - Track pending requests with timeout
       - Match responses by ID
       - Reject on timeout or error

    3. **Events:**
       - Emit typed events for chat.message, tool calls, etc.
       - EventEmitter-based for flexibility

    4. **Reconnection:**
       - Exponential backoff (default: 1s, 2s, 4s... max 30s)
       - Configurable max attempts (default: 10)
       - Emit 'reconnecting' and 'reconnected' events

    5. **Error handling:**
       - Emit 'error' events
       - Proper cleanup on disconnect
       - Timeout all pending requests on disconnect

    Avoid:
    - Polling (use WebSocket events)
    - Blocking operations
    - Logging tokens or sensitive data
  </action>
  <verify>
    - `ls src/openclaw/openclaw-client.ts` exists
    - `npm run build` succeeds
    - Types are correct (no TypeScript errors)
  </verify>
  <done>OpenClawClient class created with connection, messaging, and event handling</done>
</task>

<task type="auto">
  <name>Task 2: Add factory function and exports</name>
  <files>src/openclaw/index.ts, src/index.ts</files>
  <action>
    1. Create src/openclaw/index.ts:
    ```typescript
    export { OpenClawClient, type OpenClawClientConfig } from './openclaw-client.js';

    // Factory function for convenience
    export async function createOpenClawClient(
      config?: OpenClawClientConfig
    ): Promise<OpenClawClient> {
      const client = new OpenClawClient(config);
      await client.connect();
      return client;
    }
    ```

    2. Update src/index.ts to export from './openclaw':
    ```typescript
    export * from './openclaw/index.js';
    ```

    3. Environment variable support in OpenClawClient constructor:
       - OPENCLAW_GATEWAY_URL → gatewayUrl
       - OPENCLAW_GATEWAY_TOKEN → authToken
       - OPENCLAW_SESSION_SCOPE → sessionScope
  </action>
  <verify>
    - `npm run build` succeeds
    - `import { createOpenClawClient, OpenClawClient } from 'agidentity'` works in type system
  </verify>
  <done>Factory function created, exports added to package entry point</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests</name>
  <files>src/openclaw/openclaw-client.test.ts</files>
  <action>
    Create unit tests for OpenClawClient:

    1. **Connection tests:**
       - Should construct with default config
       - Should read config from environment variables
       - Should connect and complete handshake (mock WebSocket)
       - Should handle connection timeout
       - Should handle authentication failure

    2. **Request/Response tests:**
       - Should send request and receive response
       - Should timeout pending requests
       - Should reject on error response

    3. **Chat tests:**
       - Should send chat message
       - Should emit chat message events
       - Should include sender context when provided

    4. **Reconnection tests:**
       - Should attempt reconnection on disconnect
       - Should respect max attempts
       - Should use exponential backoff

    Use jest mocking for WebSocket - no actual OpenClaw needed for unit tests.
  </action>
  <verify>
    - `npm test src/openclaw/openclaw-client.test.ts` passes
    - Coverage includes happy path and error cases
  </verify>
  <done>Unit tests passing for OpenClawClient</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `src/openclaw/openclaw-client.ts` created with WebSocket client
- [ ] `src/openclaw/index.ts` exports client and factory
- [ ] `src/index.ts` re-exports openclaw module
- [ ] `npm run build` succeeds
- [ ] `npm test src/openclaw/` passes
</verification>

<success_criteria>

- OpenClawClient class implements WebSocket communication with OpenClaw Gateway
- Connection management with reconnection
- Request/response pattern with timeouts
- Event handling for chat messages
- Factory function for easy initialization
- Unit tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/04-openclaw-gateway/04-02-SUMMARY.md`:

# Phase 4 Plan 02: OpenClaw WebSocket Client Summary

**[One-liner summary]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- [File list with descriptions]

## Decisions Made

[Decisions, or "None"]

## Issues Encountered

[Issues, or "None"]

## Next Step

Ready for 04-03-PLAN.md (AGIdentity OpenClaw Gateway)
</output>
