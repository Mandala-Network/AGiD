---
phase: 05-shad-semantic-memory
plan: 03
type: execute
---

<objective>
Integrate memory server with AGIdentityOpenClawGateway for AI long-term memory retrieval.

Purpose: Connect the memory system to the gateway so AI can retrieve relevant context before responding.
Output: AGIdentityOpenClawGateway with integrated memory search and optional Shad escalation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-shad-semantic-memory/05-RESEARCH.md

# Gateway to integrate with
@src/gateway/agidentity-openclaw-gateway.ts

# Memory components from previous plans
@src/memory/agidentity-memory-server.ts
@src/shad/shad-temp-executor.ts

# Vault implementations
@src/vault/local-encrypted-vault.ts

**Integration approach:**
1. Gateway gets optional memory server config
2. Before forwarding to OpenClaw, auto-retrieve relevant context
3. Inject retrieved context into OpenClaw session
4. For complex tasks (heuristic: multi-step, research keywords), optionally escalate to Shad

**Established patterns:**
- AGIdentityOpenClawGateway: MessageBox → IdentityGate → OpenClaw → MPC Sign
- Graceful degradation: Services can fail without crashing gateway
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add memory configuration to gateway</name>
  <files>src/gateway/agidentity-openclaw-gateway.ts</files>
  <action>
Extend AGIdentityOpenClawGateway to support memory:

1. Add to AGIdentityOpenClawGatewayConfig:
   ```typescript
   /** Memory configuration */
   memory?: {
     /** Vault for document storage */
     vault?: LocalEncryptedVault;
     /** Whether to auto-retrieve context before OpenClaw (default: true) */
     autoRetrieve?: boolean;
     /** Maximum documents to retrieve (default: 3) */
     retrieveLimit?: number;
     /** Optional Shad executor for complex tasks */
     shadExecutor?: ShadTempVaultExecutor;
   };
   ```

2. Add private fields:
   - `private memoryServer?: AGIdentityMemoryServer`
   - `private shadExecutor?: ShadTempVaultExecutor`

3. In constructor/initialize:
   - If config.memory?.vault provided, create AGIdentityMemoryServer
   - Store shadExecutor if provided

4. Add helper method:
   ```typescript
   private async retrieveContext(query: string): Promise<string | null> {
     if (!this.memoryServer) return null;

     try {
       const results = await this.memoryServer.search(query, {
         limit: this.config.memory?.retrieveLimit ?? 3
       });

       if (results.length === 0) return null;

       // Fetch content for top results
       const contextParts: string[] = [];
       for (const result of results) {
         const content = await this.memoryServer.get(result.path);
         if (content) {
           contextParts.push(`--- ${result.path} ---\n${content}`);
         }
       }

       return contextParts.length > 0
         ? `Relevant context from memory:\n\n${contextParts.join('\n\n')}`
         : null;
     } catch (error) {
       console.warn('Memory retrieval failed:', error);
       return null; // Graceful degradation
     }
   }
   ```

Do NOT make memory required - it's optional enhancement.
Do NOT block message processing if memory fails - graceful degradation.
  </action>
  <verify>npm run build passes</verify>
  <done>Gateway accepts memory config, creates memory server, has retrieveContext helper</done>
</task>

<task type="auto">
  <name>Task 2: Integrate memory retrieval into message flow</name>
  <files>src/gateway/agidentity-openclaw-gateway.ts</files>
  <action>
Connect memory to the message processing flow:

1. In the message handler (where OpenClaw is called), add context retrieval:
   ```typescript
   // Before sending to OpenClaw, retrieve relevant context
   let contextPrefix = '';
   if (this.config.memory?.autoRetrieve !== false && this.memoryServer) {
     const retrievedContext = await this.retrieveContext(message.content);
     if (retrievedContext) {
       contextPrefix = retrievedContext + '\n\n---\n\nUser message:\n';
     }
   }

   // Send to OpenClaw with context prefix
   const messageToSend = contextPrefix + message.content;
   ```

2. Add optional Shad escalation for complex tasks:
   ```typescript
   private isComplexTask(content: string): boolean {
     // Heuristic: keywords suggesting multi-step reasoning
     const complexKeywords = [
       'analyze', 'research', 'synthesize', 'compare',
       'across all', 'summarize everything', 'pattern'
     ];
     const lower = content.toLowerCase();
     return complexKeywords.some(kw => lower.includes(kw));
   }

   private async escalateToShad(task: string): Promise<string | null> {
     if (!this.shadExecutor) return null;

     try {
       const result = await this.shadExecutor.execute(task, {
         strategy: 'research',
         maxDepth: 3,
         maxTime: 120
       });

       if (result.success) {
         return result.output;
       }
       console.warn('Shad execution failed:', result.error);
       return null;
     } catch (error) {
       console.warn('Shad escalation failed:', error);
       return null; // Graceful fallback to standard retrieval
     }
   }
   ```

3. In message handler, check for complex tasks:
   ```typescript
   // For complex tasks, try Shad first if available
   if (this.shadExecutor && this.isComplexTask(message.content)) {
     const shadResult = await this.escalateToShad(message.content);
     if (shadResult) {
       contextPrefix = `Research results:\n\n${shadResult}\n\n---\n\nUser message:\n`;
     }
   }
   ```

Keep it simple - Shad is optional enhancement, not required.
  </action>
  <verify>npm run build passes</verify>
  <done>Memory retrieval integrated into message flow, optional Shad escalation works</done>
</task>

<task type="auto">
  <name>Task 3: Add tests and update exports</name>
  <files>src/gateway/agidentity-openclaw-gateway.test.ts, src/index.ts</files>
  <action>
1. Add memory-related tests to gateway test file:
   - Test gateway initializes without memory config (backward compatible)
   - Test gateway initializes with memory config
   - Test retrieveContext returns null when no results
   - Test retrieveContext returns formatted context
   - Test isComplexTask identifies complex queries
   - Test Shad escalation gracefully handles unavailable Shad
   - Use mock vault and mock Shad executor

2. Update src/index.ts:
   - Ensure memory module exports are included
   - Add re-export: `export * from './memory/index.js'`

3. Update README or add JSDoc:
   - Document memory configuration options
   - Show example with memory enabled:
   ```typescript
   const gateway = await createAGIdentityGateway({
     wallet,
     trustedCertifiers: [caPublicKey],
     openclawUrl: 'ws://127.0.0.1:18789',
     memory: {
       vault: await createLocalEncryptedVault({ vaultPath: '~/Documents/Vault', wallet }),
       autoRetrieve: true,
       retrieveLimit: 3,
     },
   });
   ```
  </action>
  <verify>npm test passes, exports work</verify>
  <done>Tests pass, memory integration documented, Phase 5 complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] Gateway works without memory config (backward compatible)
- [ ] Gateway retrieves context when memory enabled
- [ ] Shad escalation is optional and graceful
- [ ] Phase 5 complete - all 3 plans done
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Memory integration works end-to-end
- Backward compatible with existing gateway usage
- Phase 5: Shad Semantic Memory complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-shad-semantic-memory/05-03-SUMMARY.md`

Include in summary:
- Phase 5 complete
- Memory system: OpenClaw MCP server (primary) + Shad temp vault (secondary)
- Gateway integration: auto-retrieve context, optional Shad escalation
- Project status: All 5 phases complete
</output>
