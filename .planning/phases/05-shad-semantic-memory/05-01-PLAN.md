---
phase: 05-shad-semantic-memory
plan: 01
type: execute
---

<objective>
Create OpenClaw MCP Memory Server exposing encrypted vault as memory tools.

Purpose: Provide the primary (90% of use cases) retrieval mechanism for AI long-term memory with privacy-preserving local search.
Output: AGIdentityMemoryServer MCP server with memory_search, memory_get, and verify_document tools.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-shad-semantic-memory/05-RESEARCH.md

# Prior phase context
@.planning/phases/04-openclaw-gateway/04-03-SUMMARY.md

# Existing vault implementations
@src/vault/local-encrypted-vault.ts
@src/shad/encrypted-vault.ts

**Tech stack available:** MCP SDK, LocalEncryptedVault, EncryptedShadVault
**Established patterns:** Factory functions, Zod validation, memory caching with TTL

**Research findings:**
- OpenClaw memory tools: memory_search(query, limit), memory_get(path)
- Hybrid search (vector + BM25) provides best recall
- Local embeddings required for privacy (no external API calls)
- verify_document returns blockchain provenance (VaultProof)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AGIdentityMemoryServer MCP server</name>
  <files>src/memory/agidentity-memory-server.ts, src/memory/index.ts</files>
  <action>
Create MCP server exposing encrypted vault as memory tools:

1. Create `src/memory/agidentity-memory-server.ts`:
   - Class `AGIdentityMemoryServer` implementing MCP server pattern
   - Constructor takes vault (LocalEncryptedVault or EncryptedShadVault) and optional userPublicKey
   - Tool: `memory_search(query: string, limit?: number)` - hybrid search returning paths, scores, snippets
   - Tool: `memory_get(path: string)` - decrypt and return single document content
   - Use existing vault.search() and vault.read() methods (already implemented)
   - Return results in MCP-compatible format (content array with type: 'text')

2. Create `src/memory/index.ts` with exports

Use @modelcontextprotocol/sdk pattern but keep it simple - we're wrapping existing vault methods.
Do NOT add vector embeddings yet (research suggests starting simple, add if needed).
Do NOT call external APIs for embeddings - privacy requirement.
  </action>
  <verify>npm run build passes, new files exist</verify>
  <done>AGIdentityMemoryServer class with memory_search and memory_get tools, exported from src/memory/index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add verify_document tool and factory function</name>
  <files>src/memory/agidentity-memory-server.ts, src/index.ts</files>
  <action>
Add blockchain provenance verification:

1. Add tool: `verify_document(path: string)` to AGIdentityMemoryServer
   - For EncryptedShadVault: call vault.getVaultProof(path) returning VaultProof with blockchainTxId
   - For LocalEncryptedVault: return { exists: true } (no blockchain backing)
   - Return proof as JSON in MCP response

2. Add factory function `createAGIdentityMemoryServer(config)`:
   - Config: { vault: LocalEncryptedVault | EncryptedShadVault, userPublicKey?: string }
   - Return initialized server instance

3. Export from src/index.ts:
   - AGIdentityMemoryServer
   - createAGIdentityMemoryServer

4. Add unit tests in src/memory/agidentity-memory-server.test.ts:
   - Test memory_search returns results
   - Test memory_get returns content
   - Test verify_document returns proof
   - Use mock vault (no real encryption needed for tests)
  </action>
  <verify>npm test -- --grep "AGIdentityMemoryServer" passes</verify>
  <done>verify_document tool works, factory function exported, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] AGIdentityMemoryServer exported from src/index.ts
- [ ] memory_search, memory_get, verify_document tools work
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- MCP memory server ready for gateway integration
</success_criteria>

<output>
After completion, create `.planning/phases/05-shad-semantic-memory/05-01-SUMMARY.md`
</output>
