---
phase: 02-messagebox-channel
plan: 01
type: execute
---

<objective>
Integrate MessageBox message reception with IdentityGate for sender verification.

Purpose: Every incoming message must have its sender's identity verified before processing. This is the security foundation for the MessageBox channel.
Output: GatedMessageHandler that wraps AGIDMessageClient with certificate-based sender verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/01-interface-hardening/01-04-SUMMARY.md

# Key source files:
@src/messaging/message-client.ts
@src/identity/identity-gate.ts
@src/types/index.ts

**Tech stack available:** Zod validation, BRC-100 wallet interface, MessageBoxClient
**Established patterns:** Session cleanup with setInterval, Zod schema validation, gatedOperation wrapper
**Constraining decisions:**
- Phase 1: Zod validation required for all JSON parsing
- Phase 1: 30-minute session timeout for cleanup
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GatedMessageHandler with identity verification</name>
  <files>src/messaging/gated-message-handler.ts</files>
  <action>
Create GatedMessageHandler class that:
1. Takes AGIDMessageClient, IdentityGate, and config in constructor
2. Wraps `onMessage` to verify sender identity before calling user handler
3. Maintains a cache of verified sender certificates (Map<senderKey, Certificate>)
4. Provides `registerSenderCertificate(senderKey, certificate)` for pre-registration
5. On message receipt:
   - Check if sender has registered certificate
   - If yes: verify with IdentityGate.verifyIdentity()
   - If no certificate and requireCertificate=true: reject message, optionally send rejection notice
   - If verified: call user's message handler with verified context
6. Export VerifiedMessage type extending AGIDMessage with `verified: boolean`, `certificate?: Certificate`, `verificationError?: string`

Use Zod schema for any config validation. Follow existing pattern from identity-gate.ts for verification caching.
Do NOT use any 'any' types - define proper interfaces.
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>GatedMessageHandler class exists with verifyAndHandle method, VerifiedMessage type exported, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Add certificate exchange protocol for MessageBox</name>
  <files>src/messaging/gated-message-handler.ts, src/messaging/index.ts</files>
  <action>
Extend GatedMessageHandler with certificate exchange:
1. Add `requestCertificate(recipientKey)` method that sends a certificate request message to a specific messageBox (e.g., 'agid-cert-exchange')
2. Add `handleCertificateExchange()` that listens on 'agid-cert-exchange' messageBox for:
   - Certificate requests: respond with own certificate
   - Certificate responses: register received certificate with registerSenderCertificate()
3. Define CertificateExchangeMessage type with Zod schema:
   - type: 'request' | 'response'
   - certificate?: Certificate (for responses)
   - requestId: string
4. Update src/messaging/index.ts to export GatedMessageHandler and related types

This enables automatic certificate discovery - when receiving a message from unknown sender, request their certificate before processing.
  </action>
  <verify>npx tsc --noEmit passes, grep -r "GatedMessageHandler" src/messaging/index.ts shows export</verify>
  <done>Certificate exchange protocol implemented, types exported from messaging module index</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` succeeds without errors
- [ ] GatedMessageHandler class created with identity verification
- [ ] VerifiedMessage type properly extends AGIDMessage
- [ ] Certificate exchange protocol implemented
- [ ] All new types exported from src/messaging/index.ts
- [ ] No 'any' types used in new code
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- GatedMessageHandler integrates IdentityGate with AGIDMessageClient
- Certificate exchange enables sender verification for MessageBox
</success_criteria>

<output>
After completion, create `.planning/phases/02-messagebox-channel/02-01-SUMMARY.md`
</output>
