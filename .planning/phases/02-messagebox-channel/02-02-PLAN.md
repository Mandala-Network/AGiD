---
phase: 02-messagebox-channel
plan: 02
type: execute
---

<objective>
Create conversation threading and session management for MessageBox communication.

Purpose: Track ongoing conversations between employees and AI, maintain context across messages, and enable session-based encryption.
Output: ConversationManager that tracks message threads with session state and integrates with SessionEncryption.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/02-messagebox-channel/02-01-SUMMARY.md

# Key source files:
@src/messaging/message-client.ts
@src/messaging/gated-message-handler.ts
@src/encryption/per-interaction.ts
@src/types/index.ts

**Tech stack available:** Zod validation, SessionEncryption, PerInteractionEncryption
**Established patterns:** Session cleanup with setInterval (30-min timeout, 5-min cleanup interval), Map-based caching
**Constraining decisions:**
- 30-minute session timeout for cleanup (from Phase 1)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConversationManager for MessageBox sessions</name>
  <files>src/messaging/conversation-manager.ts</files>
  <action>
Create ConversationManager class that:
1. Tracks conversations by composite key: `${senderPublicKey}:${conversationId}`
2. Each Conversation has:
   - conversationId: string (derived from first message or explicit)
   - participantKey: string (the other party's public key)
   - messages: Array of { messageId, direction, timestamp, bodyPreview }
   - createdAt: number
   - lastActivityAt: number
   - sessionEncryption: SessionEncryption instance (for PFS)
   - metadata?: Record<string, unknown>
3. Provide methods:
   - `getOrCreateConversation(participantKey, conversationId?)` - returns existing or creates new
   - `addMessage(conversationId, message, direction)` - tracks message in conversation
   - `getConversation(conversationId)` - retrieve by ID
   - `getConversationsForParticipant(participantKey)` - list all with a participant
   - `endConversation(conversationId)` - mark conversation ended, cleanup
4. Implement session cleanup following Phase 1 pattern:
   - SESSION_TIMEOUT_MS = 30 * 60 * 1000 (30 minutes)
   - CLEANUP_INTERVAL_MS = 5 * 60 * 1000 (5 minutes)
   - cleanupStaleConversations() removes conversations with lastActivityAt older than timeout
   - setInterval for periodic cleanup

Define Conversation interface and ConversationMessage interface with proper types.
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>ConversationManager class exists with session tracking, cleanup implemented, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ConversationManager with message flow</name>
  <files>src/messaging/conversation-manager.ts, src/messaging/index.ts</files>
  <action>
Add integration helpers to ConversationManager:
1. Add `processIncomingMessage(message: VerifiedMessage)` method that:
   - Extracts conversationId from message body if present (check for body.conversationId)
   - Falls back to generating conversationId from sender + timestamp if not present
   - Gets or creates conversation
   - Adds message to conversation
   - Returns { conversation, isNew: boolean }
2. Add `prepareOutgoingMessage(participantKey, conversationId, body)` method that:
   - Gets conversation (throws if not found)
   - Uses conversation's SessionEncryption for additional encryption layer if needed
   - Returns prepared message body with conversationId included
3. Add `getSessionEncryption(conversationId)` to retrieve SessionEncryption for a conversation
4. Export ConversationManager and all types from src/messaging/index.ts

Ensure VerifiedMessage import from gated-message-handler.ts works correctly.
  </action>
  <verify>npx tsc --noEmit passes, grep -r "ConversationManager" src/messaging/index.ts shows export</verify>
  <done>ConversationManager fully integrated, exports added to messaging index, message flow helpers work</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` succeeds without errors
- [ ] ConversationManager tracks conversations with session state
- [ ] Session cleanup implemented (30-min timeout, 5-min interval)
- [ ] processIncomingMessage and prepareOutgoingMessage methods work
- [ ] SessionEncryption integration for PFS per conversation
- [ ] All types exported from src/messaging/index.ts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Conversation threading tracks messages by participant
- Session timeout cleanup prevents memory leaks
- Ready for MessageBox Gateway integration
</success_criteria>

<output>
After completion, create `.planning/phases/02-messagebox-channel/02-02-SUMMARY.md`
</output>
