---
phase: 02-messagebox-channel
plan: 03
type: execute
---

<objective>
Create MessageBoxGateway as the unified entry point for AI communication via MessageBox.

Purpose: Provide a single, secure gateway that handles the complete message lifecycle: receive → verify identity → track conversation → process → respond.
Output: MessageBoxGateway class that integrates AGIDMessageClient, GatedMessageHandler, IdentityGate, and ConversationManager.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/02-messagebox-channel/02-01-SUMMARY.md
@.planning/phases/02-messagebox-channel/02-02-SUMMARY.md

# Key source files:
@src/messaging/message-client.ts
@src/messaging/gated-message-handler.ts
@src/messaging/conversation-manager.ts
@src/identity/identity-gate.ts
@src/wallet/agent-wallet.ts

**Tech stack available:** AGIDMessageClient, GatedMessageHandler, ConversationManager, IdentityGate, SessionEncryption
**Established patterns:** Factory functions (createMessageClient, createAGIdentity), async initialization
**Constraining decisions:**
- MessageBox is primary channel (PROJECT.md)
- All messages must pass through IdentityGate
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MessageBoxGateway class</name>
  <files>src/messaging/messagebox-gateway.ts</files>
  <action>
Create MessageBoxGateway class that orchestrates the full message flow:

1. Constructor takes MessageBoxGatewayConfig:
   - wallet: AgentWallet
   - identityGate: IdentityGate
   - messageBoxes: string[] (which boxes to listen on, default ['inbox'])
   - requireCertificate?: boolean (default true)
   - onMessage: (message: ProcessedMessage) => Promise<MessageResponse | null>
   - onError?: (error: GatewayError) => void

2. Internal components (created in constructor):
   - messageClient: AGIDMessageClient
   - gatedHandler: GatedMessageHandler
   - conversationManager: ConversationManager

3. Provide async initialize() method that:
   - Initializes messageClient
   - Initializes identityGate
   - Sets up gatedHandler certificate exchange
   - Starts listening on configured messageBoxes
   - Starts conversation cleanup interval

4. Message flow (internal):
   - Message arrives via messageClient
   - gatedHandler verifies sender identity
   - conversationManager tracks in conversation
   - onMessage callback receives ProcessedMessage with full context
   - If callback returns MessageResponse, send reply via messageClient
   - Acknowledge original message after processing

5. Define types:
   - ProcessedMessage: { original: VerifiedMessage, conversation: Conversation, context: ProcessingContext }
   - ProcessingContext: { identityVerified: boolean, certificate?: Certificate, conversationId: string, isNewConversation: boolean }
   - MessageResponse: { body: string | object, encrypt?: boolean }
   - GatewayError: { type: 'verification' | 'processing' | 'delivery', message: string, originalMessage?: AGIDMessage }

6. Provide shutdown() method for graceful cleanup (stop listeners, clear intervals)
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>MessageBoxGateway class created with full message lifecycle, types defined, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Add factory function and exports</name>
  <files>src/messaging/messagebox-gateway.ts, src/messaging/index.ts, src/index.ts</files>
  <action>
1. Add createMessageBoxGateway factory function to messagebox-gateway.ts:
   - Takes simplified config (wallet, trustedCertifiers, onMessage, options?)
   - Creates IdentityGate internally with provided trustedCertifiers
   - Returns initialized MessageBoxGateway (call initialize() before returning)
   - Signature: async function createMessageBoxGateway(config: CreateGatewayConfig): Promise<MessageBoxGateway>

2. Update src/messaging/index.ts to export:
   - MessageBoxGateway class
   - createMessageBoxGateway function
   - All gateway-related types (ProcessedMessage, MessageResponse, GatewayError, etc.)

3. Update src/index.ts to re-export from messaging:
   - Add export for createMessageBoxGateway
   - Add export for MessageBoxGateway
   - Ensure it's accessible as `import { createMessageBoxGateway } from 'agidentity'`

Follow existing factory pattern from createMessageClient and createAGIdentity.
  </action>
  <verify>npx tsc --noEmit passes, grep "createMessageBoxGateway" src/index.ts shows export</verify>
  <done>Factory function created, all exports in place, accessible from main package entry</done>
</task>

<task type="auto">
  <name>Task 3: Add convenience methods and documentation</name>
  <files>src/messaging/messagebox-gateway.ts</files>
  <action>
Add convenience methods to MessageBoxGateway:

1. sendMessage(recipientKey: string, body: string | object, conversationId?: string): Promise<{ messageId: string }>
   - If conversationId provided, use existing conversation's context
   - Otherwise create ad-hoc message
   - Uses messageClient.sendMessage internally

2. getConversation(conversationId: string): Conversation | undefined
   - Delegate to conversationManager

3. getConversationsWithParticipant(participantKey: string): Conversation[]
   - Delegate to conversationManager

4. getIdentityGate(): IdentityGate
   - Return internal identityGate for admin operations (certificate issuance, etc.)

5. isRunning(): boolean
   - Return whether gateway is actively listening

6. Add comprehensive JSDoc comments to:
   - Class description with usage example
   - All public methods
   - All exported types

Example usage in class JSDoc:
```typescript
const gateway = await createMessageBoxGateway({
  wallet,
  trustedCertifiers: [caPublicKey],
  onMessage: async (msg) => {
    console.log(`From ${msg.original.sender}: ${msg.original.body}`);
    return { body: 'Message received!' };
  }
});
// Gateway is now listening for messages
```
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>Convenience methods added, JSDoc documentation complete, gateway fully functional</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` succeeds without errors
- [ ] MessageBoxGateway orchestrates full message lifecycle
- [ ] createMessageBoxGateway factory function works
- [ ] Exported from src/index.ts for package consumers
- [ ] Convenience methods for common operations
- [ ] JSDoc documentation on all public APIs
- [ ] Graceful shutdown implemented
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- MessageBoxGateway is the single entry point for MessageBox communication
- Full flow: receive → verify → track → process → respond
- Phase 2 complete - MessageBox is primary channel for employee ↔ AI communication
</success_criteria>

<output>
After completion, create `.planning/phases/02-messagebox-channel/02-03-SUMMARY.md`:

# Phase 2 Plan 3: MessageBox Gateway Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Phase 2 complete
- Ready for Phase 3: MPC Wallet Interface
</output>
